{% extends 'base_user_center.html' %}
{% load staticfiles %}
{% block rightmenu %}
    <div class="right_content clearfix">
        <h3 class="common_title2">全部订单</h3>
        {% for order in page_orders %}
            <ul class="order_list_th w978 clearfix">
                <li class="col01">{{ order.create_time }}</li>
                <li class="col02">订单号：{{ order.order_id }}</li>
                <li class="col02 stress">{{ order.status_name }}</li>
            </ul>

            <table class="order_list_table w980">
                <tbody>
                    <tr>
                        <td width="55%">
                            {% for good in order.order_goods %}
                                <ul class="order_goods_list clearfix">
                                <li class="col01"><img src="{{ good.sku.image.url }}"></li>
                                <li class="col02">{{ good.sku.name }}<em>{{ good.price }}元/{{ good.sku.unite }}</em></li>
                                <li class="col03">{{ good.count }}</li>
                                <li class="col04">{{ good.amount }}元</li>
                            </ul>
                            {% endfor %}
                        </td>
                        <td width="15%">{{ order.total_pay }}元(含运费{{ order.transit_price }})</td>
                        <td width="15%">{{ order.status_name }}</td>
                    {% csrf_token %}
                        <td width="15%"><a href="#" order_id ="{{ order.order_id }}" status = "{{ order.order_status }}" class="oper_btn">去付款</a></td>
                    </tr>
                </tbody>
            </table>
        {% endfor %}
				<div class="pagenation">
                    {% if page_orders.has_previous %}
					    <a href="{% url 'user:order' page_orders.previous_page_number %}"><上一页</a>
                    {% endif %}
                    {% for pindex in pages %}
					    <a href="{% url 'user:order' pindex %}" {% if pindex == page_orders.number %}class="active"{% endif %}>{{ pindex }}</a>
                    {% endfor %}
                    {% if page_orders.has_next %}
					    <a href="{% url 'user:order' page_orders.next_page_number %}">下一页></a>
                    {% endif %}
				</div>
		</div>
{% endblock rightmenu %}

{% block bottomfiles %}
    <script src="{% static 'js/jquery-1.12.4.min.js' %}"></script>
    <script>
        $('.oper_btn').each(function () {
            var status = $(this).attr('status');
            var dict = {"1":"待支付", "2":"查看物流",　"3":"去评价",　"4":"已完成"}
            $(this).text(dict[status])
        })

        $('.oper_btn').click(function () {
            var status = $(this).attr('status');
            if (status == 1){
                //支付
                //获取订单ｉｄ
                var order_id = $(this).attr('order_id');
                var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                var context = {"order_id": order_id, "csrfmiddlewaretoken": csrf};
                $.post('/order/pay', context, function (data) {
                    if (data.res == 3){
                        window.open(data.pay_url);
                        $.post('/order/check', context, function (data) {
                            if (data.res == 3){
                                alert(data.msg)
                                location.reload()
                            }else {
                                alert(data.errmsg)
                            }

                        })
                    }else {
                        alert(data.errmsg);
                    }
                })

            }else {
                //其他操作
            }

        })


    </script>
{% endblock bottomfiles %}



